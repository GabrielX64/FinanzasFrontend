<div class="payment-plan-container">

  <!-- Header -->
  <header class="app-header">
    <div class="header-content">
      <h1 class="app-title">üè† Sistema de Cr√©dito MiVivienda</h1>
      <div class="user-section">
        <span class="username">üë§ Asesor Inmobiliario</span>
        <button class="btn-logout" (click)="logout()">Cerrar Sesi√≥n</button>
      </div>
    </div>
  </header>

  <!-- Progress Steps -->
  <div class="progress-container" *ngIf="!showResults">
    <div class="progress-steps">
      <div class="step" [class.active]="currentStep >= 1" [class.completed]="currentStep > 1">
        <div class="step-number">1</div>
        <div class="step-label">Cliente</div>
      </div>
      <div class="step-line" [class.completed]="currentStep > 1"></div>
      <div class="step" [class.active]="currentStep >= 2" [class.completed]="currentStep > 2">
        <div class="step-number">2</div>
        <div class="step-label">Pr√©stamo</div>
      </div>
      <div class="step-line" [class.completed]="currentStep > 2"></div>
      <div class="step" [class.active]="currentStep >= 3">
        <div class="step-number">3</div>
        <div class="step-label">Resultados</div>
      </div>
    </div>
  </div>

  <div class="main-content">

    <!-- PASO 1: REGISTRO DEL CLIENTE -->
    <div class="form-step" *ngIf="currentStep === 1">
      <div class="card">
        <div class="card-header">
          <div>
            <h2>üë§ Informaci√≥n del Cliente</h2>
            <p class="card-subtitle">Registre los datos del cliente</p>
          </div>
        </div>

        <form [formGroup]="clientForm">
          <div class="form-grid-3">
            <div class="form-group" [class.error]="isFieldInvalid(clientForm, 'names')">
              <label class="form-label">Nombres *</label>
              <input type="text" class="form-input" formControlName="names" placeholder="Ej: Juan Carlos">
              <span class="error-message" *ngIf="hasError(clientForm, 'names', 'required')">Campo requerido</span>
            </div>

            <div class="form-group" [class.error]="isFieldInvalid(clientForm, 'surnames')">
              <label class="form-label">Apellidos *</label>
              <input type="text" class="form-input" formControlName="surnames" placeholder="Ej: Garc√≠a L√≥pez">
              <span class="error-message" *ngIf="hasError(clientForm, 'surnames', 'required')">Campo requerido</span>
            </div>

            <div class="form-group" [class.error]="isFieldInvalid(clientForm, 'dni')">
              <label class="form-label">DNI *</label>
              <input type="text" class="form-input" formControlName="dni" placeholder="12345678" maxlength="8">
              <span class="error-message" *ngIf="hasError(clientForm, 'dni', 'pattern')">DNI debe tener 8 d√≠gitos</span>
            </div>

            <div class="form-group" [class.error]="isFieldInvalid(clientForm, 'email')">
              <label class="form-label">Email *</label>
              <input type="email" class="form-input" formControlName="email" placeholder="correo@ejemplo.com">
              <span class="error-message" *ngIf="hasError(clientForm, 'email', 'email')">Email inv√°lido</span>
            </div>

            <div class="form-group" [class.error]="isFieldInvalid(clientForm, 'phoneNumber')">
              <label class="form-label">Tel√©fono *</label>
              <input type="text" class="form-input" formControlName="phoneNumber" placeholder="987654321" maxlength="9">
              <span class="error-message" *ngIf="hasError(clientForm, 'phoneNumber', 'pattern')">Tel√©fono debe tener 9 d√≠gitos</span>
            </div>

            <div class="form-group" [class.error]="isFieldInvalid(clientForm, 'monthlyIncome')">
              <label class="form-label">Ingreso Mensual (S/) *</label>
              <input type="number" class="form-input" formControlName="monthlyIncome" placeholder="0.00">
              <span class="error-message" *ngIf="hasError(clientForm, 'monthlyIncome', 'required')">Campo requerido</span>
            </div>

            <div class="form-group" [class.error]="isFieldInvalid(clientForm, 'occupation')">
              <label class="form-label">Ocupaci√≥n *</label>
              <input type="text" class="form-input" formControlName="occupation" placeholder="Ej: Ingeniero">
              <span class="error-message" *ngIf="hasError(clientForm, 'occupation', 'required')">Campo requerido</span>
            </div>

            <div class="form-group" [class.error]="isFieldInvalid(clientForm, 'maritalStatusID')">
              <label class="form-label">Estado Civil *</label>
              <select class="form-input" formControlName="maritalStatusID">
                <option value="">Seleccione...</option>
                <option *ngFor="let status of maritalStatuses"
                        [value]="status.maritalStatusId || status.maritalStatusID || status.id">
                  {{ status.statusName || status.name }}
                </option>
              </select>
              <span class="error-message" *ngIf="hasError(clientForm, 'maritalStatusID', 'required')">Campo requerido</span>
            </div>

            <div class="form-group full-width" [class.error]="isFieldInvalid(clientForm, 'currentAddress')">
              <label class="form-label">Direcci√≥n Actual *</label>
              <input type="text" class="form-input" formControlName="currentAddress" placeholder="Calle, n√∫mero, distrito">
              <span class="error-message" *ngIf="hasError(clientForm, 'currentAddress', 'required')">Campo requerido</span>
            </div>
          </div>

          <div class="error-alert" *ngIf="errorMessage">
            {{ errorMessage }}
          </div>

          <div class="form-actions">
            <button type="button" class="btn-primary" (click)="nextStep()" [disabled]="isLoading">
              {{ isLoading ? 'Guardando...' : 'Siguiente ‚Üí' }}
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- PASO 2: DATOS DEL PR√âSTAMO -->
    <div class="form-step" *ngIf="currentStep === 2">
      <div class="card">
        <div class="card-header">
          <div>
            <h2>üí∞ Datos del Pr√©stamo</h2>
            <p class="card-subtitle">Configure los par√°metros del cr√©dito</p>
          </div>
        </div>

        <form [formGroup]="loanForm">

          <h3 class="section-title">Informaci√≥n de la Vivienda</h3>
          <div class="form-grid-3">
            <div class="form-group" [class.error]="isFieldInvalid(loanForm, 'propertyPrice')">
              <label class="form-label">Precio de la Vivienda (S/) *</label>
              <input type="number" class="form-input" formControlName="propertyPrice" placeholder="0.00">
              <span class="error-message" *ngIf="hasError(loanForm, 'propertyPrice', 'required')">Campo requerido</span>
            </div>

            <div class="form-group" [class.error]="isFieldInvalid(loanForm, 'principal')">
              <label class="form-label">Monto a Financiar (S/) *</label>
              <input type="number" class="form-input" formControlName="principal" placeholder="0.00">
              <span class="error-message" *ngIf="hasError(loanForm, 'principal', 'required')">Campo requerido</span>
            </div>

            <div class="form-group" [class.error]="isFieldInvalid(loanForm, 'financialEntityID')">
              <label class="form-label">Entidad Financiera *</label>
              <select class="form-input" formControlName="financialEntityID">
                <option value="">Seleccione...</option>
                <option *ngFor="let entity of financialEntities" [value]="entity.financialEntityID">
                  {{ entity.name }} ({{ entity.downPaymentPercentage }}%)
                </option>
              </select>
              <span class="error-message" *ngIf="hasError(loanForm, 'financialEntityID', 'required')">Campo requerido</span>
            </div>
          </div>

          <h3 class="section-title">Configuraci√≥n del Pr√©stamo</h3>
          <div class="form-grid-3">
            <div class="form-group" [class.error]="isFieldInvalid(loanForm, 'years')">
              <label class="form-label">Plazo (a√±os) *</label>
              <input type="number" class="form-input" formControlName="years" placeholder="20">
              <span class="error-message" *ngIf="hasError(loanForm, 'years', 'required')">Campo requerido</span>
            </div>

            <div class="form-group">
              <label class="form-label">Tipo de Tasa *</label>
              <select class="form-input" formControlName="rateType">
                <option value="TEA">Tasa Efectiva Anual (TEA)</option>
                <option value="TNP">Tasa Nominal Peri√≥dica (TNP)</option>
              </select>
            </div>

            <div class="form-group" *ngIf="loanForm.get('rateType')?.value === 'TEA'" [class.error]="isFieldInvalid(loanForm, 'tea')">
              <label class="form-label">TEA (%) *</label>
              <input type="number" class="form-input" formControlName="tea" placeholder="8.5" step="0.01">
              <span class="error-message" *ngIf="hasError(loanForm, 'tea', 'required')">Campo requerido</span>
            </div>

            <div class="form-group" *ngIf="loanForm.get('rateType')?.value === 'TNP'" [class.error]="isFieldInvalid(loanForm, 'tnp')">
              <label class="form-label">TNP (%) *</label>
              <input type="number" class="form-input" formControlName="tnp" placeholder="8.0" step="0.01">
              <span class="error-message" *ngIf="hasError(loanForm, 'tnp', 'required')">Campo requerido</span>
            </div>

            <div class="form-group" *ngIf="loanForm.get('rateType')?.value === 'TNP'">
              <label class="form-label">Frecuencia de Capitalizaci√≥n *</label>
              <select class="form-input" formControlName="capitalizationFrequencyID">
                <option value="">Seleccione...</option>
                <option value="4">Mensual</option>
                <option value="6">Bimestral</option>
                <option value="7">Trimestral</option>
              </select>
            </div>
          </div>

          <h3 class="section-title">Per√≠odos de Gracia (Opcional)</h3>
          <div class="form-grid-2">
            <div class="form-group">
              <label class="form-label">Gracia Total (meses)</label>
              <input type="number" class="form-input" formControlName="totalGrace" placeholder="0">
              <small class="form-hint">No se paga cuota, el inter√©s se capitaliza</small>
            </div>

            <div class="form-group">
              <label class="form-label">Gracia Parcial (meses)</label>
              <input type="number" class="form-input" formControlName="partialGrace" placeholder="0">
              <small class="form-hint">Solo se pagan intereses</small>
            </div>
          </div>

          <h3 class="section-title">Tasa de Descuento</h3>
          <div class="form-grid-3">
            <div class="form-group">
              <label class="form-label">COK - Costo de Oportunidad (%) *</label>
              <input type="number" class="form-input" formControlName="cok" placeholder="10" step="0.1">
              <small class="form-hint">Tasa de descuento para calcular VAN</small>
            </div>
          </div>

          <div class="error-alert" *ngIf="errorMessage">
            {{ errorMessage }}
          </div>

          <div class="form-actions">
            <button type="button" class="btn-secondary" (click)="prevStep()">
              ‚Üê Anterior
            </button>
            <button type="button" class="btn-primary" (click)="nextStep()" [disabled]="isLoading">
              {{ isLoading ? 'Calculando...' : 'üìä Calcular Plan ‚Üí' }}
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- PASO 3: RESULTADOS -->
    <div class="results-container" *ngIf="currentStep === 3 && showResults">

      <!-- Resumen del Cliente -->
      <div class="card">
        <div class="card-header">
          <div>
            <h3>üë§ Cliente Registrado</h3>
          </div>
          <div class="header-actions">
            <button class="btn-icon" (click)="editClient()" title="Editar cliente">‚úèÔ∏è Editar</button>
          </div>
        </div>
        <div class="summary-data">
          <p><strong>Nombre:</strong> {{ clientData?.names }} {{ clientData?.surnames }}</p>
          <p><strong>DNI:</strong> {{ clientData?.dni }}</p>
          <p><strong>Ingreso Mensual:</strong> S/ {{ clientData?.monthlyIncome | number:'1.2-2' }}</p>
        </div>
      </div>

      <!-- Indicadores Financieros -->
      <div class="card indicators-card">
        <div class="card-header">
          <div>
            <h2>üìä Indicadores Financieros</h2>
          </div>
          <div class="header-actions">
            <button class="btn-icon" (click)="editLoan()" title="Editar pr√©stamo">‚úèÔ∏è Editar</button>
          </div>
        </div>

        <div class="indicators-grid">
          <div class="indicator">
            <div class="indicator-label">TEA</div>
            <div class="indicator-value">{{ tea | number:'1.2-2' }}%</div>
            <div class="indicator-desc">Tasa Efectiva Anual</div>
          </div>
          <div class="indicator">
            <div class="indicator-label">TCEA</div>
            <div class="indicator-value">{{ tcea | number:'1.2-2' }}%</div>
            <div class="indicator-desc">Tasa Costo Efectivo Anual</div>
          </div>
          <div class="indicator">
            <div class="indicator-label">TREA</div>
            <div class="indicator-value">{{ trea | number:'1.2-2' }}%</div>
            <div class="indicator-desc">Tasa Rendimiento Efectivo</div>
          </div>
          <div class="indicator">
            <div class="indicator-label">VAN</div>
            <div class="indicator-value">S/ {{ van | number:'1.2-2' }}</div>
            <div class="indicator-desc">Valor Actual Neto</div>
          </div>
          <div class="indicator">
            <div class="indicator-label">TIR</div>
            <div class="indicator-value">{{ tir | number:'1.2-2' }}%</div>
            <div class="indicator-desc">Tasa Interna de Retorno</div>
          </div>
        </div>
      </div>

      <!-- Tarjetas de Resumen -->
      <div class="summary-cards">
        <div class="summary-card card-blue">
          <div class="card-icon">üíµ</div>
          <div class="card-info">
            <p class="card-label">Cuota Mensual</p>
            <p class="card-value">S/ {{ cuotaMensual | number:'1.2-2' }}</p>
          </div>
        </div>

        <div class="summary-card card-green">
          <div class="card-icon">üìà</div>
          <div class="card-info">
            <p class="card-label">Total Intereses</p>
            <p class="card-value">S/ {{ totalIntereses | number:'1.2-2' }}</p>
          </div>
        </div>

        <div class="summary-card card-purple">
          <div class="card-icon">üí∞</div>
          <div class="card-info">
            <p class="card-label">Total a Pagar</p>
            <p class="card-value">S/ {{ totalPagado | number:'1.2-2' }}</p>
          </div>
        </div>
      </div>

      <!-- Informaci√≥n de Cuota Inicial -->
      <div class="card">
        <h3>üè¶ Informaci√≥n del Financiamiento - {{ selectedFinancialEntity }}</h3>
        <div class="transparency-info">
          <div class="info-row">
            <span class="info-label">Precio de la Vivienda:</span>
            <span class="info-value">S/ {{ loanForm.get('propertyPrice')?.value | number:'1.2-2' }}</span>
          </div>
          <div class="info-row">
            <span class="info-label">Cuota Inicial ({{ downPaymentPercentage | number:'1.2-2' }}%):</span>
            <span class="info-value">S/ {{ downPayment | number:'1.2-2' }}</span>
          </div>
          <div class="info-row">
            <span class="info-label">Monto Financiado:</span>
            <span class="info-value">S/ {{ financedAmount | number:'1.2-2' }}</span>
          </div>
        </div>
      </div>

      <!-- Cronograma de Pagos -->
      <div class="card table-card">
        <div class="card-header">
          <div>
            <h2>üìÖ Cronograma de Pagos - M√©todo Franc√©s</h2>
          </div>
          <div class="header-actions">
            <button class="btn-export" (click)="exportToPDF()">üì• Exportar PDF</button>
          </div>
        </div>

        <div class="table-container">
          <table class="payment-table">
            <thead>
            <tr>
              <th>Per√≠odo</th>
              <th>Saldo Inicial</th>
              <th>Cuota</th>
              <th>Inter√©s</th>
              <th>Amortizaci√≥n</th>
              <th>Saldo Final</th>
            </tr>
            </thead>
            <tbody>
            <tr *ngFor="let payment of paymentPlan"
                [class.grace-period]="payment.amortization === 0 && payment.fee === 0"
                [class.partial-grace]="payment.fee > 0 && payment.amortization === 0">
              <td class="text-center">{{ payment.period }}</td>
              <td class="text-right">{{ payment.initialBalance | number:'1.2-2' }}</td>
              <td class="text-right bold">{{ payment.fee | number:'1.2-2' }}</td>
              <td class="text-right text-red">{{ payment.interest | number:'1.2-2' }}</td>
              <td class="text-right text-green">{{ payment.amortization | number:'1.2-2' }}</td>
              <td class="text-right">{{ payment.finalBalance | number:'1.2-2' }}</td>
            </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Acciones Finales -->
      <div class="final-actions">
        <button class="btn-secondary" (click)="resetForm()">
          üîÑ Nueva Simulaci√≥n
        </button>
      </div>

    </div>

  </div>

</div>
